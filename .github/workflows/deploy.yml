name: Publish to Roblox

on:
  push:
    branches:
      - main  # Workflow uruchomi się przy każdym pushu na gałąź main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Rust
      uses: actions/setup-rust@v1
      with:
        rust-version: '1.68.2'

    - name: Set up Lua
      uses: actionshub/setup-lua@v2
      with:
        lua-version: '5.1'

    - name: Install dependencies
      run: |
        cargo build
        cargo install rojo stylua wally

    - name: Build project
      run: |
        cargo build && lune ayachapter.rbxl && rojo --output=build/rojo_output

    - name: Deploy to Roblox
      env:
        API_KEY: ${{ secrets.API_KEY }}
      run: |
        UNIVERSE_ID="4125094708"
        PLACE_ID="11633610328"
        FILE_PATH="./build/rojo_output/game.rbxl"

        # Sprawdzenie, czy plik istnieje
        if [ ! -f "$FILE_PATH" ]; then
          echo "Plik .rbxl nie istnieje w ścieżce: $FILE_PATH"
          exit 1
        fi

        # Publikowanie za pomocą curl
        echo "Publikowanie miejsca na Robloxie..."
        curl --verbose --location POST "https://apis.roblox.com/universes/v1/$UNIVERSE_ID/places/$PLACE_ID/versions?versionType=Published" \
        --header "x-api-key: $API_KEY" \
        --header "Content-Type: application/octet-stream" \
        --data-binary @"$FILE_PATH"

        if [ $? -eq 0 ]; then
          echo "Miejsce zostało pomyślnie opublikowane!"
        else
          echo "Błąd podczas publikacji miejsca."
          exit 1
        fi